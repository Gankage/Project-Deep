<!DOCTYPE html>
<html>
<head>
    <title>The Deep: Watch Interface</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <style>
        body { background-color: #121212; color: white; font-family: courier, monospace; text-align: center; padding-top: 30px; user-select: none; }
        .watch-face { border: 2px solid #444; padding: 20px; display: inline-block; border-radius: 30px; background: #000; width: 320px; box-shadow: 0 0 20px #111; }
        h1 { color: #00ffcc; text-shadow: 0 0 10px #00ffcc; margin-bottom: 5px; font-size: 28px; }
        
        .stat-box { margin: 15px 0; border: 1px solid #333; padding: 10px; border-radius: 10px; background: #111; }
        .stat-label { font-size: 12px; color: #888; letter-spacing: 2px; margin-bottom: 5px; }
        .stat-value { font-size: 36px; font-weight: bold; color: #fff; }
        
        .btn-row { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        button { padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; font-family: courier, monospace; font-weight: bold; }
        .btn-dmg { background-color: #ff3333; color: white; }
        .btn-heal { background-color: #33cc33; color: black; }
        
        .slots-container { display: flex; justify-content: center; gap: 15px; margin-top: 25px; }
        .slot { width: 60px; height: 60px; border: 2px dashed #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #444; transition: all 0.3s; }
        
        .slot.fire { border: 2px solid #ff4400; background: radial-gradient(circle, #ffaa00 0%, #ff4400 100%); color: black; box-shadow: 0 0 15px #ff4400; text-shadow: none; font-weight: bold; border-style: solid;}
        .slot.water { border: 2px solid #00ccff; background: radial-gradient(circle, #ccffff 0%, #00ccff 100%); color: black; box-shadow: 0 0 15px #00ccff; text-shadow: none; font-weight: bold; border-style: solid;}
        .slot.earth { border: 2px solid #8B4513; background: radial-gradient(circle, #D2691E 0%, #8B4513 100%); color: white; box-shadow: 0 0 15px #8B4513; text-shadow: none; font-weight: bold; border-style: solid;}
        .slot.wind { border: 2px solid #ADD8E6; background: radial-gradient(circle, #E0FFFF 0%, #87CEEB 100%); color: black; box-shadow: 0 0 15px #ADD8E6; text-shadow: none; font-weight: bold; border-style: solid;}
        .slot.time { border: 2px solid #FFD700; background: radial-gradient(circle, #FFFACD 0%, #DAA520 100%); color: black; box-shadow: 0 0 15px #DAA520; text-shadow: none; font-weight: bold; border-style: solid;}
        .slot.empty { background: transparent; }

        .loading { color: gray; font-size: 14px; }
        .error { color: #ff3333; font-size: 16px; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="watch-face">
        <div id="ui-container">
            <div class="loading">Booting Sequence...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBCToYnskZ2co0iZfvEZ13zHiEYXw6eO1c",
            authDomain: "the-deep-1c05d.firebaseapp.com",
            projectId: "the-deep-1c05d",
            storageBucket: "the-deep-1c05d.firebasestorage.app",
            messagingSenderId: "646004798304",
            appId: "1:646004798304:web:f1f5083b44de1dfc56a405",
            measurementId: "G-95E7GGPPD5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- NEW "REMEMBER ME" LOGIC ---
        
        // 1. Check URL for ID
        const urlParams = new URLSearchParams(window.location.search);
        let userId = urlParams.get('uid');

        // 2. If URL has ID, save it to phone memory
        if (userId) {
            localStorage.setItem("deep_userid", userId);
            console.log("Identity Saved:", userId);
        } 
        // 3. If URL is empty, look in phone memory
        else {
            userId = localStorage.getItem("deep_userid");
            console.log("Identity Loaded from Memory:", userId);
        }
        
        // -------------------------------

        let playerRef = null;
        let localData = null;

        if (!userId) {
            document.getElementById("ui-container").innerHTML = `
                <div class='error'>NO SIGNAL DETECTED</div>
                <p style="color:#666; font-size:12px; margin-top:10px;">
                    1. Close this app.<br>
                    2. Open the link with ?uid=player_1 in Chrome.<br>
                    3. Re-open this app.
                </p>
            `;
        } else {
            // Connect to that specific player
            playerRef = doc(db, "users", userId);
            
            // Listen for data
            onSnapshot(playerRef, (docSnap) => {
                if (docSnap.exists()) {
                    localData = docSnap.data();
                    renderApp(localData);
                } else {
                    document.getElementById("ui-container").innerHTML = `<div class='error'>UNKNOWN SOUL: ${userId}</div>`;
                }
            });
        }

        function renderApp(data) {
            const container = document.getElementById("ui-container");
            
            function drawSlot(type) {
                let safeType = type || 'empty';
                let className = safeType === 'empty' ? 'slot' : `slot ${safeType}`;
                let label = safeType === 'empty' ? '' : safeType.toUpperCase().substring(0, 1);
                return `<div class="${className}">${label}</div>`;
            }

            container.innerHTML = `
                <h1>${data.name}</h1>
                
                <div class="stat-box">
                    <div class="stat-label">VITALITY</div>
                    <div class="stat-value" style="color: ${data.hp <= 3 ? 'red' : 'white'}">${data.hp} / ${data.maxHp}</div>
                    <div class="btn-row">
                        <button id="btn-dmg" class="btn-dmg">-</button>
                        <button id="btn-heal" class="btn-heal">+</button>
                    </div>
                </div>

                <div class="stat-box">
                    <div class="stat-label">LIVES</div>
                    <div class="stat-value">${data.lives}</div>
                </div>

                <div class="slots-container">
                    ${drawSlot(data.slot1)}
                    ${drawSlot(data.slot2)}
                    ${drawSlot(data.slot3)}
                </div>
            `;

            document.getElementById("btn-dmg").addEventListener("click", () => adjustHealth(-1));
            document.getElementById("btn-heal").addEventListener("click", () => adjustHealth(1));
        }

        async function adjustHealth(amount) {
            if (!localData || !playerRef) return;
            let newHp = localData.hp + amount;
            if (newHp < 0) newHp = 0;
            if (newHp > localData.maxHp) newHp = localData.maxHp;
            await updateDoc(playerRef, { hp: newHp });
        }
    </script>

</body>

</html>
