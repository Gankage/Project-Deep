<!DOCTYPE html>
<html>
<head>
    <title>The Deep: Watch Interface</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <style>
        body { background-color: #000; color: white; font-family: courier, monospace; text-align: center; padding-top: 20px; user-select: none; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; align-items: center; }
        
        /* The Device Container */
        .watch-face { 
            border: 2px solid #333; padding: 20px; border-radius: 40px; 
            background: linear-gradient(145deg, #111, #000); 
            width: 85%; max-width: 350px; 
            box-shadow: 0 0 30px #000; 
            position: relative; flex-grow: 1; max-height: 80vh;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        h1 { color: #00ffcc; text-shadow: 0 0 10px #00ffcc; margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        /* Stats Area */
        .stats-row { display: flex; justify-content: space-between; margin-top: 15px; gap: 10px; }
        .stat-box { border: 1px solid #333; padding: 10px; border-radius: 10px; background: #0a0a0a; flex-grow: 1; }
        .stat-label { font-size: 10px; color: #666; letter-spacing: 1px; margin-bottom: 2px; }
        .stat-value { font-size: 28px; font-weight: bold; color: #fff; }
        
        /* Buttons */
        .btn-row { display: flex; justify-content: center; gap: 5px; margin-top: 5px; }
        button { padding: 8px 15px; font-size: 14px; border: none; border-radius: 4px; cursor: pointer; font-family: courier, monospace; font-weight: bold; }
        .btn-dmg { background-color: #cc2222; color: white; }
        .btn-heal { background-color: #22cc22; color: black; }
        
        /* THE ARC REACTOR (Master Slot) */
        .reactor-container { 
            display: flex; justify-content: center; align-items: center; 
            margin: 20px 0; flex-grow: 1; 
        }
        .master-slot { 
            width: 140px; height: 140px; 
            border: 4px dashed #333; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 14px; color: #333; 
            transition: all 0.5s ease; 
            cursor: pointer;
            position: relative;
        }

        /* Active Token Styles */
        .master-slot.active { border-style: solid; box-shadow: 0 0 30px rgba(255,255,255,0.1); animation: pulse 3s infinite; }
        .master-slot.fire { border-color: #ff4400; background: radial-gradient(circle, #ffaa00 0%, #330000 100%); color: transparent; box-shadow: 0 0 40px #ff4400; }
        .master-slot.water { border-color: #00ccff; background: radial-gradient(circle, #ccffff 0%, #001133 100%); color: transparent; box-shadow: 0 0 40px #00ccff; }
        .master-slot.earth { border-color: #8B4513; background: radial-gradient(circle, #D2691E 0%, #1a0f00 100%); color: transparent; box-shadow: 0 0 40px #8B4513; }
        .master-slot.wind { border-color: #ADD8E6; background: radial-gradient(circle, #E0FFFF 0%, #002233 100%); color: transparent; box-shadow: 0 0 40px #ADD8E6; }
        
        /* Token Icon (Letter in middle) */
        .token-icon { font-size: 60px; font-weight: bold; color: rgba(255,255,255,0.8); text-shadow: 0 0 10px black; }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Popup */
        #item-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .modal-content { background: #111; border: 2px solid #00ffcc; padding: 30px; border-radius: 20px; width: 80%; text-align: center; box-shadow: 0 0 30px rgba(0,255,204,0.2); }
        .close-btn { margin-top: 20px; padding: 15px 40px; background: transparent; color: #00ffcc; border: 1px solid #00ffcc; border-radius: 5px; text-transform: uppercase; letter-spacing: 2px; }

        .loading { color: gray; font-size: 12px; margin-top: 20px;}
        .error { color: #ff3333; }
    </style>
</head>
<body>

    <div id="item-modal">
        <div class="modal-content">
            <h2 id="m-title" style="color:#00ffcc; margin:0 0 10px 0;">SCANNING...</h2>
            <div id="m-type" style="color:#666; font-size:10px; margin-bottom:20px;">...</div>
            <p id="m-desc" style="color:#ccc; font-style:italic; line-height:1.5;">Reading data...</p>
            <div id="m-effect" style="border-top:1px solid #333; padding-top:15px; margin-top:15px; color:#fff; font-weight:bold;"></div>
            <button class="close-btn" onclick="closeModal()">CLOSE</button>
        </div>
    </div>

    <div class="watch-face">
        <div id="ui-container" style="height:100%; display:flex; flex-direction:column;">
            <div class="loading">Booting Sequence...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBCToYnskZ2co0iZfvEZ13zHiEYXw6eO1c",
            authDomain: "the-deep-1c05d.firebaseapp.com",
            projectId: "the-deep-1c05d",
            storageBucket: "the-deep-1c05d.firebasestorage.app",
            messagingSenderId: "646004798304",
            appId: "1:646004798304:web:f1f5083b44de1dfc56a405",
            measurementId: "G-95E7GGPPD5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Identity Logic
        const urlParams = new URLSearchParams(window.location.search);
        let userId = urlParams.get('uid');
        if (userId) { localStorage.setItem("deep_userid", userId); } 
        else { userId = localStorage.getItem("deep_userid"); }
        
        let playerRef = null;
        let localData = null;

        if (!userId) {
            document.getElementById("ui-container").innerHTML = `<div class='error' style='margin:auto;'>NO SIGNAL</div>`;
        } else {
            playerRef = doc(db, "users", userId);
            onSnapshot(playerRef, (docSnap) => {
                if (docSnap.exists()) {
                    localData = docSnap.data();
                    renderApp(localData);
                }
            });
        }

        function renderApp(data) {
            const container = document.getElementById("ui-container");
            
            // New "activeToken" Logic
            const token = data.activeToken || 'empty';
            const isActive = token !== 'empty';
            const displayChar = isActive ? token.charAt(0).toUpperCase() : '';
            
            container.innerHTML = `
                <h1>${data.name}</h1>
                
                <div class="reactor-container">
                    <div class="master-slot ${token} ${isActive ? 'active' : ''}" 
                         onclick="window.showItem('${token}')">
                         <div class="token-icon">${displayChar}</div>
                    </div>
                </div>

                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-label">VITALITY</div>
                        <div class="stat-value" style="color: ${data.hp <= 3 ? '#ff3333' : '#fff'}">${data.hp} / ${data.maxHp}</div>
                        <div class="btn-row">
                            <button class="btn-dmg" id="btn-dmg">-</button>
                            <button class="btn-heal" id="btn-heal">+</button>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">LIVES</div>
                        <div class="stat-value">${data.lives}</div>
                    </div>
                </div>
            `;

            document.getElementById("btn-dmg").addEventListener("click", () => adjustHealth(-1));
            document.getElementById("btn-heal").addEventListener("click", () => adjustHealth(1));
        }

        async function adjustHealth(amount) {
            if (!localData || !playerRef) return;
            let newHp = localData.hp + amount;
            if (newHp < 0) newHp = 0;
            if (newHp > localData.maxHp) newHp = localData.maxHp;
            await updateDoc(playerRef, { hp: newHp });
        }

        // Popup Logic
        window.showItem = async (type) => {
            if (!type || type === 'empty') return;
            
            const modal = document.getElementById("item-modal");
            document.getElementById("m-title").innerText = "ACCESSING...";
            document.getElementById("m-desc").innerText = "Decrypting rune data...";
            document.getElementById("m-effect").innerText = "";
            modal.style.display = "flex";

            const itemId = "token_" + type; 
            try {
                const itemSnap = await getDoc(doc(db, "items", itemId));
                if (itemSnap.exists()) {
                    const i = itemSnap.data();
                    document.getElementById("m-title").innerText = i.name;
                    document.getElementById("m-type").innerText = i.type;
                    document.getElementById("m-desc").innerText = i.description;
                    document.getElementById("m-effect").innerText = i.effect;
                } else {
                    document.getElementById("m-title").innerText = "UNKNOWN";
                    document.getElementById("m-desc").innerText = "No database entry found.";
                }
            } catch (e) { console.error(e); }
        };

        window.closeModal = () => { document.getElementById("item-modal").style.display = "none"; };
    </script>
</body>
</html>
